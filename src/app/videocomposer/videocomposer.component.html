<app-breadcrumb
    [links]="[{display:'Layer Finder', path:'layerFinder' }, {display:'Clip Composer', path:'clipComposer' }, {display:'Video Composer', path:'videoComposer' }]">
</app-breadcrumb>
<div class="container">
    <h1>Video Composer</h1>
    <p class="lead">Video composer allows you to combine clips to either make a new video or edit an existing one.</p>
    <p>Once you create a video you can then use this to <a [routerLink]="['/videoBuilder']">build a video</a>. Use the
        controls below to create or edit your videos</p>
    <ng-container *ngIf="!showEditor && this.videos.length > 0">
        <h2>Videos</h2>
        <div class="mb-3">
            <div class="row">
                <div *ngFor="let video of videos; let i = index" class="col-sm mb-3">
                    <div class="card text-center">
                        <div class="imageContainer">
                            <ng-container *ngIf="video.clips?.length ?? 0 > 0">
                                <img *ngFor="let layerloop of video.clips[0].userLayers; let i = index"
                                    [src]="'https://cdn.musicvideobuilder.com/' + layerloop.layerId + '/' + layerloop.layerId + '.png'"
                                    [alt]="layerloop.layerName" [style.left.px]="0" [style.z-index]="i" />
                            </ng-container>
                        </div>
                        <h5 class="card-header">{{video.videoName}}.{{Formats[video.format]}}</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">BPM: {{video.bpm}}</li>
                            <li class="list-group-item">
                                <button type="button" (click)="editVideo(video)" class="btn btn-primary">
                                    <i class="bi bi-pencil-square"></i> Edit</button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </ng-container>
    <span [ngbTooltip]="canAddVideoTooltip()" placement="right" *ngIf="!showEditor">
        <button type="button" class="btn btn-success" (click)="toggleEditor()" [disabled]="!canAddVideo()"><i
                class="bi bi-dash-circle-fill"></i>
            Add new video</button>
    </span>
    <ng-container *ngIf="showEditor">
        <h2>Video Editor</h2>
        <form [formGroup]="videoForm" (ngSubmit)="onSubmit()">
            <ul ngbNav #nav="ngbNav" class="nav-tabs" [(activeId)]="activeTabId">
                <li [ngbNavItem]="1">
                    <a ngbNavLink>Details</a>
                    <ng-template ngbNavContent>
                        <div class="mb-3">
                            <label for="videoName" class="form-label">Video Name</label>
                            <input type="text" class="form-control" id="videoName" formControlName="videoNameControl" />
                            <div class="form-text">Try to pick something short. Has to be Alpha Numeric and unique
                                across your
                                videos.
                            </div>
                            <div class="form-text text-danger"
                                *ngIf="videoNameControl?.invalid  && (videoNameControl?.dirty || videoNameControl?.touched)">
                                <div [hidden]="!videoNameControl?.errors?.['required']">
                                    Video name is required.
                                </div>
                                <div [hidden]="!videoNameControl?.errors?.['maxlength']">
                                    Video name max length is 50 characters.
                                </div>
                                <div [hidden]="!videoNameControl?.errors?.['pattern']">
                                    Video name must be alpha numeric.
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="videoBpm" class="form-label">Video BPM (playback speed)</label>
                            <input type="number" class="form-control" min="90" max="250" step="1" id="videoBpm"
                                formControlName="bpmControl" />
                            <div class="form-text">Must be between 90 and 250 beats per minute.
                            </div>
                            <div class="form-text text-danger"
                                *ngIf="bpmControl?.invalid  && (bpmControl?.dirty || bpmControl?.touched)">
                                <div [hidden]="!bpmControl?.errors?.['required']">
                                    BPM is required.
                                </div>
                                <div [hidden]="!bpmControl?.errors?.['min']">
                                    BPM must be over 90.
                                </div>
                                <div [hidden]="!bpmControl?.errors?.['max']">
                                    BPM must be under 250
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="format" class="form-label">Format</label>
                            <select id="format" formControlName="formatControl" class="form-control">
                                <option [ngValue]="lt" *ngFor="let lt of formatList">
                                    {{Formats[lt]}}
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="videoDelayMilliseconds" class="form-label">Video Delay in milliseconds</label>
                            <input type="number" class="form-control" min="0" max="2147483647" step="1"
                                id="videoDelayMilliseconds" formControlName="videoDelayMillisecondsControl" />
                            <div class="form-text">This is the delay in milliseconds from the start of your audio to
                                where the first
                                beat kicks in. This will be when the video starts. Leave blank or 0 for no delay.
                            </div>
                            <div class="form-text text-danger"
                                *ngIf="videoDelayMillisecondsControl?.invalid  && (videoDelayMillisecondsControl?.dirty || videoDelayMillisecondsControl?.touched)">
                                <div [hidden]="!videoDelayMillisecondsControl?.errors?.['max']">
                                    Delay must be less than 2147483647.
                                </div>
                                <div [hidden]="!videoDelayMillisecondsControl?.errors?.['pattern']">
                                    Delay must be a positive whole numnber.
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="audioFile" class="form-label">Audio File Selector</label>
                            <input class="form-control" type="file" id="audioFile" accept=".mp3"
                                (change)="onFileUpload($event)" />
                            <div id="LayerImagesHelp" class="form-text">
                                This is to add audio when you play your video and is optional. If this is an existing
                                video you will need to select your track again as we don't upload these files. Also
                                limited to mp3 format due to browser restrictions.
                            </div>
                            <label for="audioFileName" class="form-label">Audio File Name</label>
                            <input type="text" class="form-control" id="audioFileName"
                                formControlName="audioFileNameControl" />
                            <div class="form-text text-danger" *ngIf="audioFileNameControl?.invalid">
                                <div [hidden]="!audioFileNameControl?.errors?.['pattern']">
                                    Audio file name must be alphanumeric or contain brackets, hypthens or spaces.
                                </div>
                                <div [hidden]="!audioFileNameControl?.errors?.['maxlength']">
                                    Audio file name max length is 50 characters.
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <span [ngbTooltip]="bpmInvalidTooltip()" placement="right">
                                <button type="button" [disabled]="!bpmControl.valid" class="btn btn-secondary"
                                    (click)="activeTabId = 2">Go to timeline</button>
                            </span>
                        </div>
                    </ng-template>
                </li>
                <li [ngbNavItem]="2" [disabled]="!bpmControl.valid" [ngbTooltip]="bpmInvalidTooltip()"
                    placement="right">
                    <a ngbNavLink>Timeline</a>
                    <ng-template ngbNavContent>
                        <ng-container *ngIf="showEditor && !showClipPicker">
                            <div class="mb-3">
                                <label for="clipsPerBlock" class="form-label">Number of clips per timeline block</label>
                                <select id="clipsPerBlock" class="form-control" formControlName="clipsPerBlockControl">
                                    <option [ngValue]="1">
                                        1
                                    </option>
                                    <option [ngValue]="4">
                                        4
                                    </option>
                                    <option [ngValue]="16">
                                        16
                                    </option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <div class="row" *ngIf="this.clipsFormArray.length > 0">
                                    <ng-container
                                        *ngFor="let clipControl of this.clipsFormArray.controls; let i = index">
                                        <div class="col-3 mb-3" *ngIf="i % clipsPerBlock === 0">
                                            <div class="card text-center">
                                                <div class="timeLineImageContainer">
                                                    <img *ngFor="let layerloop of clipControl.value.userLayers; let i = index"
                                                        [src]="'https://cdn.musicvideobuilder.com/' + layerloop.layerId + '/' + layerloop.layerId + '.png'"
                                                        [alt]="layerloop.layerName" [style.left.px]="0"
                                                        [style.z-index]="i" />
                                                </div>
                                                <h5 class="card-header">{{calculateClipNameFromClipIndex(i)}}</h5>
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item">
                                                        <span [ngbTooltip]="'Start player from here.'">
                                                            <button type="button" class="btn btn-info me-1"
                                                                (click)="setSelectedClipIndex(i)"
                                                                [disabled]="i === this.selectedClipIndex">
                                                                <i class="bi bi-bookmark-star-fill"></i></button>
                                                        </span>
                                                        <span [ngbTooltip]="'Move back'"
                                                            *ngIf="i > 0 && i + clipsPerBlock <= clipsFormArray.length">
                                                            <button type="button" class="btn btn-secondary me-1"
                                                                (click)="moveBack(i)">
                                                                <i class="bi bi-arrow-left-circle-fill"></i></button>
                                                        </span>
                                                        <span [ngbTooltip]="'Remove'">
                                                            <button type="button" class="btn btn-danger me-1"
                                                                (click)="removeClip(i)">
                                                                <i class="bi bi-dash-circle-fill"></i></button>
                                                        </span>
                                                        <span [ngbTooltip]="'Add copy after current'">
                                                            <button type="button" class="btn btn-primary me-1"
                                                                (click)="copyClip(i)">
                                                                <i class="bi bi-files"></i></button>
                                                        </span>
                                                        <span [ngbTooltip]="'Move forward'"
                                                            *ngIf="i + 2 * clipsPerBlock <= clipsFormArray.length">
                                                            <button type="button" class="btn btn-secondary"
                                                                (click)="moveForward(i)">
                                                                <i class="bi bi-arrow-right-circle-fill"></i></button>
                                                        </span>
                                                    </li>
                                                    <li class="list-group-item">
                                                        Beat #: {{calculateBeatRangeFromClipIndex(i)}}
                                                    </li>
                                                    <li class="list-group-item">
                                                        Time: {{calculateTimeRangeFromClipIndex(i) }}
                                                    </li>
                                                    <li class="list-group-item">
                                                        <div class="progress">
                                                            <div class="progress-bar" role="progressbar"
                                                                aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                                                                [style.width.%]="getProgress(i)"></div>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </ng-container>
                                </div>
                                <div class="form-text text-danger"
                                    *ngIf="clipsFormArray?.invalid">
                                    <div
                                        [hidden]="!clipsFormArray?.errors?.['required']">
                                        You must have 1 clip as a minimum.
                                    </div>
                                    <div [hidden]="!clipsFormArray?.errors?.['maxlength']">
                                        You can't have more than 32767 clips in a video.
                                    </div>
                                </div>
                                <span>
                                    <button type="button" (click)="toggleClipPicker()" class="btn btn-success">
                                        <i class="bi bi-plus-circle-fill"></i> Add clip to end</button>
                                </span>
                            </div>
                        </ng-container>
                        <div class="mb-3" *ngIf="showClipPicker">
                            <h3>Pick a clip</h3>
                            <div class="mb-3">
                                <div class="row">
                                    <div *ngFor="let clip of clips; let i = index" class="col-sm mb-3">
                                        <app-galleryplayer [clip]="clip" [bpm]="bpmControl.value"
                                            (addButtonClickClipEvent)="addClipPickerClip($event)">
                                        </app-galleryplayer>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn btn-secondary" (click)="activeTabId = 1">Go to
                                details</button>
                        </div>
                    </ng-template>
                </li>

                <!-- <div class="mb-3" *ngIf="layersFormArray.length === 0">
                    <h3>Pick a background</h3>
                    <div class="row">
                        <div *ngFor="let layer of userBackgrounds; let i = index" class="col-sm mb-3">
                            <app-galleryplayer [layer]="layer" (addButtonClickEvent)="addLayer($event)" [bpm]="bpm"
                                [isPlaying]="isPlaying">
                            </app-galleryplayer>
                        </div>
                    </div>
                </div>
                <ng-container *ngIf="layersFormArray.length > 0 && isAddingLayer === false">
                    <div class="mb-3">
                        <h3>Clip layers</h3>
                        <ol class="list-group list-group-numbered">
                            <li *ngFor="let layerControl of layersFormArray.controls; let i = index"
                                class="list-group-item">
                                {{layerControl.value.layerName}}
                                <div class="btn-group float-end" role="group">
                                    <button *ngIf="i > 1" type="button" class="btn btn-secondary" (click)="moveUp(i)"><i
                                            class="bi bi-arrow-up-circle-fill"></i> Move Up</button>
                                    <button *ngIf="i !== layersFormArray.controls.length - 1 && i !== 0" type="button"
                                        class="btn btn-secondary" (click)="moveDown(i)"><i
                                            class="bi bi-arrow-down-circle-fill"></i> Move
                                        Down</button>
                                    <button *ngIf="i === layersFormArray.controls.length - 1" type="button"
                                        class="btn btn-danger" (click)="removeLayer(i)"><i
                                            class="bi bi-dash-circle-fill"></i>
                                        Remove</button>
                                </div>
                            </li>
                        </ol>
                    </div>
                    <div class="mb-3">
                        <span [ngbTooltip]="canAddLayerTooltip()" placement="right">
                            <button type="button" class="btn btn-success" (click)="toggleAddNewLayer()"
                                [disabled]="!canAddLayer()">
                                <i class="bi bi-plus-circle-fill"></i> Add Another Layer</button>
                        </span>
                    </div>
                    <div class="mb-3">
                        <app-galleryplayer [clip]="editorClip" [bpm]="bpm" [isPlaying]="isPlaying" [showAdd]="false">
                            </app-galleryplayer>
                    </div>
                </ng-container>
                <div class="mb-3" *ngIf="isAddingLayer === true">
                    <h3>Pick a foreground</h3>
                    <div class="row">
                        <div *ngFor="let layer of userForegrounds; let i = index" class="col-sm mb-3">
                            <app-galleryplayer [layer]="layer" (addButtonClickEvent)="addLayer($event)"
                                [disableFunction]="disableLayer" [disableTooltipFunction]="disableLayerTooltip" [bpm]="bpm"
                                [isPlaying]="isPlaying">
                            </app-galleryplayer>
                        </div>
                    </div>
                    <button type="button" class="btn btn-danger" (click)="toggleAddNewLayer()">
                        <i class="bi bi-dash-circle-fill"></i> Cancel Adding Layer</button>
                </div> -->
            </ul>
            <div [ngbNavOutlet]="nav"></div>
            <button type="submit" [disabled]="!videoForm.valid || saving" class="btn btn-primary me-1">Save</button>
            <button type="button" class="btn btn-danger" (click)="toggleEditor()"><i class="bi bi-dash-circle-fill"></i>
                Cancel</button>
        </form>
    </ng-container>
</div>

{{videos | json}}